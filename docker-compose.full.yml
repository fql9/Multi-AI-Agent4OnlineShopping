# ============================================================
# Multi-AI-Agent Shopping System - Complete Docker Configuration
# ============================================================
# ä½¿ç”¨æ–¹æ³•:
#   å¼€å‘ç¯å¢ƒ: docker compose -f docker-compose.full.yml up -d
#   ç”Ÿäº§ç¯å¢ƒ: docker compose -f docker-compose.full.yml --profile production up -d
#
# ä¾èµ–é¡ºåº: postgres â†’ redis â†’ core-mcp/checkout-mcp â†’ tool-gateway â†’ web-app/agent
# ============================================================

services:
  # ========================================
  # ğŸ—„ï¸ PostgreSQL æ•°æ®åº“ (å« pgvector å‘é‡æ‰©å±•)
  # ========================================
  postgres:
    image: pgvector/pgvector:pg16
    container_name: agent-postgres
    ports:
      - "${POSTGRES_PORT:-5433}:5432"
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-agent}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-agent_dev_password}
      POSTGRES_DB: ${POSTGRES_DB:-agent_db}
      # æ€§èƒ½è°ƒä¼˜
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8 --lc-collate=C --lc-ctype=C"
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ./infra/docker/init-db.sql:/docker-entrypoint-initdb.d/01-init-db.sql:ro
      - ./infra/docker/migrations:/docker-entrypoint-initdb.d/migrations:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-agent} -d ${POSTGRES_DB:-agent_db}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped
    networks:
      - agent-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ========================================
  # ğŸ”´ Redis ç¼“å­˜æœåŠ¡
  # ========================================
  redis:
    image: redis:7-alpine
    container_name: agent-redis
    ports:
      - "${REDIS_PORT:-6379}:6379"
    command: >
      redis-server 
      --appendonly yes 
      --maxmemory 256mb 
      --maxmemory-policy allkeys-lru
      --requirepass ${REDIS_PASSWORD:-redis_dev_password}
    volumes:
      - redisdata:/data
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-redis_dev_password}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    networks:
      - agent-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ========================================
  # ğŸ”§ Tool Gateway (ç»Ÿä¸€å·¥å…·ç½‘å…³)
  # ========================================
  tool-gateway:
    build:
      context: .
      dockerfile: apps/tool-gateway/Dockerfile
      args:
        NODE_ENV: production
    container_name: agent-tool-gateway
    ports:
      - "${TOOL_GATEWAY_PORT:-3000}:3000"
    environment:
      NODE_ENV: production
      PORT: 3000
      # Rate limitï¼ˆå¼€å‘/æ¼”ç¤ºæ—¶é¿å…å‰ç«¯ Dock/æœç´¢è¢« 429 é™æµï¼‰
      RATE_LIMIT_ENABLED: ${RATE_LIMIT_ENABLED:-false}
      RATE_LIMIT_MAX: ${RATE_LIMIT_MAX:-1000}
      RATE_LIMIT_WINDOW: ${RATE_LIMIT_WINDOW:-1 minute}
      # æ•°æ®åº“é…ç½®
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USER: ${POSTGRES_USER:-agent}
      DB_PASSWORD: ${POSTGRES_PASSWORD:-agent_dev_password}
      DB_NAME: ${POSTGRES_DB:-agent_db}
      DATABASE_URL: postgresql://${POSTGRES_USER:-agent}:${POSTGRES_PASSWORD:-agent_dev_password}@postgres:5432/${POSTGRES_DB:-agent_db}
      # Redis é…ç½®
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-redis_dev_password}
      REDIS_URL: redis://:${REDIS_PASSWORD:-redis_dev_password}@redis:6379
      # MCP æœåŠ¡é…ç½®
      MCP_CORE_URL: http://core-mcp:3010
      MCP_CHECKOUT_URL: http://checkout-mcp:3011
      # CORS é…ç½®
      CORS_ORIGINS: ${CORS_ORIGINS:-http://localhost:3001,http://web-app:3001}
      # XOOBAY API é…ç½®
      XOOBAY_ENABLED: ${XOOBAY_ENABLED:-false}
      XOOBAY_API_KEY: ${XOOBAY_API_KEY:-}
      XOOBAY_BASE_URL: ${XOOBAY_BASE_URL:-https://www.xoobay.com}
      XOOBAY_LANG: ${XOOBAY_LANG:-en}
      # æ—¥å¿—é…ç½®
      LOG_LEVEL: ${LOG_LEVEL:-info}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    networks:
      - agent-network
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

  # ========================================
  # ğŸ“¦ Core MCP Server (Catalog/Pricing/Shipping/Tax/Compliance/Knowledge)
  # ========================================
  core-mcp:
    build:
      context: .
      dockerfile: apps/mcp-servers/core-mcp/Dockerfile
      args:
        NODE_ENV: production
    container_name: agent-core-mcp
    ports:
      - "${CORE_MCP_PORT:-3010}:3010"
    environment:
      NODE_ENV: production
      PORT: 3010
      # æ•°æ®åº“é…ç½®
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USER: ${POSTGRES_USER:-agent}
      DB_PASSWORD: ${POSTGRES_PASSWORD:-agent_dev_password}
      DB_NAME: ${POSTGRES_DB:-agent_db}
      DATABASE_URL: postgresql://${POSTGRES_USER:-agent}:${POSTGRES_PASSWORD:-agent_dev_password}@postgres:5432/${POSTGRES_DB:-agent_db}
      # Redis é…ç½®
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-redis_dev_password}
      # XOOBAY API é…ç½®
      XOOBAY_API_KEY: ${XOOBAY_API_KEY:-}
      XOOBAY_BASE_URL: ${XOOBAY_BASE_URL:-https://www.xoobay.com}
      XOOBAY_LANG: ${XOOBAY_LANG:-zh_cn}
      # æ—¥å¿—é…ç½®
      LOG_LEVEL: ${LOG_LEVEL:-info}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:3010/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    networks:
      - agent-network
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

  # ========================================
  # ğŸ›’ Checkout MCP Server (Cart/Checkout/Evidence)
  # ========================================
  checkout-mcp:
    build:
      context: .
      dockerfile: apps/mcp-servers/checkout-mcp/Dockerfile
      args:
        NODE_ENV: production
    container_name: agent-checkout-mcp
    ports:
      - "${CHECKOUT_MCP_PORT:-3011}:3011"
    environment:
      NODE_ENV: production
      PORT: 3011
      # æ•°æ®åº“é…ç½®
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USER: ${POSTGRES_USER:-agent}
      DB_PASSWORD: ${POSTGRES_PASSWORD:-agent_dev_password}
      DB_NAME: ${POSTGRES_DB:-agent_db}
      DATABASE_URL: postgresql://${POSTGRES_USER:-agent}:${POSTGRES_PASSWORD:-agent_dev_password}@postgres:5432/${POSTGRES_DB:-agent_db}
      # Redis é…ç½®
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-redis_dev_password}
      # æ—¥å¿—é…ç½®
      LOG_LEVEL: ${LOG_LEVEL:-info}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:3011/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    networks:
      - agent-network
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

  # ========================================
  # ğŸŒ Web App (Next.js å‰ç«¯)
  # ========================================
  web-app:
    build:
      context: .
      dockerfile: apps/web-app/Dockerfile
      args:
        NODE_ENV: production
    container_name: agent-web-app
    ports:
      - "${WEB_APP_PORT:-3001}:3001"
    environment:
      NODE_ENV: production
      PORT: 3001
      # API é…ç½® - å®¢æˆ·ç«¯ä½¿ç”¨å¤–éƒ¨åœ°å€ï¼ŒæœåŠ¡ç«¯ä½¿ç”¨å†…éƒ¨åœ°å€
      # Agent API (Python backend)
      NEXT_PUBLIC_AGENT_API_URL: ${NEXT_PUBLIC_AGENT_API_URL:-http://localhost:8000}
      # Tool Gateway API
      NEXT_PUBLIC_TOOL_GATEWAY_URL: ${NEXT_PUBLIC_TOOL_GATEWAY_URL:-http://localhost:3000}
      TOOL_GATEWAY_URL: http://tool-gateway:3000
    depends_on:
      tool-gateway:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:3001"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped
    networks:
      - agent-network
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

  # ========================================
  # ğŸ Python Agent (LangGraph ç¼–æ’å±‚)
  # ========================================
  agent:
    build:
      context: .
      dockerfile: agents/Dockerfile
      args:
        PYTHON_VERSION: "3.11"
    container_name: agent-python
    ports:
      - "${AGENT_PORT:-8000}:8000"
    environment:
      APP_ENV: production
      DEBUG: "false"
      PORT: 8000
      # æ•°æ®åº“é…ç½®
      DATABASE_URL: postgresql+asyncpg://${POSTGRES_USER:-agent}:${POSTGRES_PASSWORD:-agent_dev_password}@postgres:5432/${POSTGRES_DB:-agent_db}
      # Redis é…ç½®
      REDIS_URL: redis://:${REDIS_PASSWORD:-redis_dev_password}@redis:6379
      # Tool Gateway é…ç½®
      TOOL_GATEWAY_URL: http://tool-gateway:3000
      # LLM é…ç½® (å¿…éœ€)
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      OPENAI_BASE_URL: ${OPENAI_BASE_URL:-https://api.openai.com/v1}
      OPENAI_MODEL_PLANNER: ${OPENAI_MODEL_PLANNER:-gpt-4o-mini}
      OPENAI_MODEL_VERIFIER: ${OPENAI_MODEL_VERIFIER:-gpt-4o}
      # Token é¢„ç®—
      TOKEN_BUDGET_TOTAL: ${TOKEN_BUDGET_TOTAL:-50000}
      TOKEN_BUDGET_PER_STEP: ${TOKEN_BUDGET_PER_STEP:-5000}
      # ä¼šè¯é…ç½®
      SESSION_STORAGE_PATH: /app/data/sessions
      SESSION_TTL_HOURS: ${SESSION_TTL_HOURS:-24}
      # åŠŸèƒ½å¼€å…³
      MOCK_TOOLS: ${MOCK_TOOLS:-false}
      RAG_ENABLED: ${ENABLE_RAG:-true}
      # æ—¥å¿—é…ç½®
      LOG_LEVEL: ${LOG_LEVEL:-info}
    volumes:
      - agent-sessions:/app/data/sessions
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      tool-gateway:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://127.0.0.1:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped
    networks:
      - agent-network
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

  # ========================================
  # ğŸ”„ æ•°æ®åº“è¿ç§»æœåŠ¡ (ä¸€æ¬¡æ€§è¿è¡Œ)
  # ========================================
  db-migrate:
    image: pgvector/pgvector:pg16
    container_name: agent-db-migrate
    profiles:
      - migrate
    volumes:
      - ./infra/docker/migrations:/migrations:ro
    environment:
      PGHOST: postgres
      PGPORT: 5432
      PGUSER: ${POSTGRES_USER:-agent}
      PGPASSWORD: ${POSTGRES_PASSWORD:-agent_dev_password}
      PGDATABASE: ${POSTGRES_DB:-agent_db}
    command: >
      sh -c "
        echo 'Waiting for PostgreSQL...' &&
        until pg_isready -h postgres -p 5432 -U ${POSTGRES_USER:-agent}; do
          sleep 2
        done &&
        echo 'Running migrations...' &&
        for f in /migrations/*.sql; do
          echo \"Applying: \$f\" &&
          psql -f \"\$f\" || exit 1
        done &&
        echo 'Migrations completed successfully!'
      "
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - agent-network

  # ========================================
  # ğŸ“Š æ•°æ®åº“ç®¡ç†ç•Œé¢ (å¯é€‰)
  # ========================================
  adminer:
    image: adminer:latest
    container_name: agent-adminer
    profiles:
      - tools
    ports:
      - "${ADMINER_PORT:-8080}:8080"
    environment:
      ADMINER_DEFAULT_SERVER: postgres
      ADMINER_DESIGN: hydra
    depends_on:
      - postgres
    restart: unless-stopped
    networks:
      - agent-network

  # ========================================
  # ğŸ“ˆ Redis ç®¡ç†ç•Œé¢ (å¯é€‰)
  # ========================================
  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: agent-redis-commander
    profiles:
      - tools
    ports:
      - "${REDIS_COMMANDER_PORT:-8081}:8081"
    environment:
      REDIS_HOSTS: local:redis:6379:0:${REDIS_PASSWORD:-redis_dev_password}
    depends_on:
      - redis
    restart: unless-stopped
    networks:
      - agent-network

  # ========================================
  # ğŸ”„ XOOBAY äº§å“åŒæ­¥ (ä¸€æ¬¡æ€§è¿è¡Œ)
  # docker compose -f docker-compose.full.yml --profile sync run xoobay-sync
  # ========================================
  xoobay-sync:
    image: node:20-alpine
    container_name: agent-xoobay-sync
    profiles:
      - sync
    working_dir: /app
    volumes:
      - ./scripts:/app/scripts:ro
      - ./package.json:/app/package.json:ro
      - ./pnpm-lock.yaml:/app/pnpm-lock.yaml:ro
    environment:
      NODE_ENV: production
      DB_HOST: postgres
      DB_PORT: "5432"
      DB_NAME: ${POSTGRES_DB:-agent_db}
      DB_USER: ${POSTGRES_USER:-agent}
      DB_PASSWORD: ${POSTGRES_PASSWORD:-agent_dev_password}
      XOOBAY_API_KEY: ${XOOBAY_API_KEY:-xoobay_api_ai_geo}
      XOOBAY_BASE_URL: ${XOOBAY_BASE_URL:-https://www.xoobay.com}
      XOOBAY_LANG: ${XOOBAY_LANG:-en}
    command: >
      sh -c "
        echo 'ğŸ“¦ Installing dependencies...' &&
        npm install -g pnpm tsx pg &&
        echo 'ğŸ”„ Starting XOOBAY product sync (100 pages = 2000 products)...' &&
        npx tsx /app/scripts/sync-xoobay-products.ts --pages=100 &&
        echo 'âœ… Sync completed!'
      "
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - agent-network

# ========================================
# ğŸ“ æ•°æ®å·
# ========================================
volumes:
  pgdata:
    name: agent-pgdata
  redisdata:
    name: agent-redisdata
  agent-sessions:
    name: agent-sessions

# ========================================
# ğŸŒ ç½‘ç»œé…ç½®
# ========================================
networks:
  agent-network:
    name: agent-network
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
